<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Orden</title>
    <style>
        /* Estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #202122;
            line-height: 1.6;
        }

        /* Contenedor principal estilo Wikipedia */
        .wiki-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 100vh;
        }

        /* Header estilo Wikipedia */
        .wiki-header {
            background: #f8f9fa;
            border-bottom: 1px solid #a2a9b1;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wiki-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #202122;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wiki-nav {
            display: flex;
            gap: 16px;
        }

        .wiki-nav a {
            color: #0645ad;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .wiki-nav a:hover {
            text-decoration: underline;
        }

        /* Contenido principal */
        .wiki-content {
            padding: 24px;
        }

        .wiki-title {
            border-bottom: 1px solid #a2a9b1;
            padding-bottom: 8px;
            margin-bottom: 16px;
            font-size: 1.8rem;
            font-weight: 400;
        }

        /* Barra de progreso horizontal */
        .progress-container {
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 4px;
            overflow: hidden;
            height: 8px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #36c, #0b5);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* Secci√≥n de b√∫squeda */
        .search-section {
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #202122;
        }

        .input-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #a2a9b1;
            border-radius: 4px;
            font-size: 1rem;
        }

        .input-group input:focus {
            outline: 2px solid #36c;
            outline-offset: -1px;
        }

        .btn {
            padding: 10px 20px;
            border: 1px solid #a2a9b1;
            border-radius: 4px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #36c;
            color: white;
            border-color: #36c;
        }

        .btn-primary:hover {
            background: #2a4b8d;
        }

        .btn-secondary {
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #e6e6e6;
        }

        /* Tarjeta de orden */
        .orden-card {
            border: 1px solid #a2a9b1;
            border-radius: 4px;
            margin-top: 24px;
            display: none;
        }

        .orden-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #a2a9b1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .numero-orden {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .estado-badge {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .estado-pendiente { background: #fff3cd; color: #856404; }
        .estado-confirmada { background: #d4edda; color: #155724; }
        .estado-preparando { background: #cce5ff; color: #004085; }
        .estado-enviada { background: #e7f3ff; color: #0056b3; }
        .estado-entregada { background: #d1ecf1; color: #0c5460; }
        .estado-cancelada { background: #f8d7da; color: #721c24; }

        .orden-details {
            padding: 20px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eaecf0;
        }

        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            min-width: 150px;
            color: #54595d;
        }

        .detail-value {
            flex: 1;
        }

        /* Timeline horizontal */
        .timeline-horizontal {
            display: flex;
            justify-content: space-between;
            margin: 24px 0;
            position: relative;
        }

        .timeline-horizontal::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 3px;
            background: #eaecf0;
            z-index: 1;
        }

        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .timeline-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #eaecf0;
            margin-bottom: 8px;
            font-size: 1.2rem;
        }

        .timeline-step.active .timeline-icon {
            background: #36c;
            color: white;
        }

        .timeline-step.completed .timeline-icon {
            background: #0b5;
            color: white;
        }

        .timeline-label {
            font-size: 0.85rem;
            text-align: center;
            max-width: 100px;
        }

        /* Secci√≥n de registro */
        .registro-section {
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            border-radius: 4px;
            padding: 20px;
            margin-top: 24px;
            text-align: center;
        }

        .registro-section h3 {
            margin-bottom: 12px;
            font-weight: 400;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #36c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error */
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin-top: 16px;
            display: none;
        }

        /* √ìrdenes guardadas */
        .ordenes-guardadas {
            margin-top: 24px;
            display: none;
        }

        .ordenes-guardadas h3 {
            border-bottom: 1px solid #a2a9b1;
            padding-bottom: 8px;
            margin-bottom: 16px;
            font-weight: 400;
        }

        .orden-guardada {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #a2a9b1;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .orden-guardada:hover {
            background: #f8f9fa;
        }

        /* Breadcrumb */
        .breadcrumb {
            margin-bottom: 16px;
            font-size: 0.9rem;
            color: #54595d;
        }

        .breadcrumb a {
            color: #0645ad;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .wiki-header {
                flex-direction: column;
                gap: 12px;
            }
            
            .timeline-horizontal {
                flex-wrap: wrap;
                gap: 16px;
            }
            
            .timeline-step {
                flex: 0 0 calc(50% - 8px);
            }
            
            .detail-row {
                flex-direction: column;
            }
            
            .detail-label {
                min-width: auto;
                margin-bottom: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="wiki-container">
        <!-- Header estilo Wikipedia -->
        <header class="wiki-header">
            <a href="#" class="wiki-logo">
                <span>üì¶</span>
                <span>Seguimiento de √ìrdenes</span>
            </a>
            <nav class="wiki-nav">
                <a href="#" id="back-link">‚Üê Volver atr√°s</a>
                <a href="#">Ayuda</a>
                <a href="#">Contacto</a>
            </nav>
        </header>

        <!-- Breadcrumb -->
        <div class="wiki-content">
            <div class="breadcrumb" id="breadcrumb">
                <a href="#">Inicio</a> > <span>Seguimiento de √≥rdenes</span>
            </div>

            <!-- T√≠tulo principal -->
            <h1 class="wiki-title">Seguimiento de √ìrdenes</h1>

            <!-- Barra de progreso horizontal -->
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>

            <!-- Secci√≥n de b√∫squeda -->
            <div class="search-section">
                <div class="input-group">
                    <label for="numeroOrden">N√∫mero de orden</label>
                    <input type="text" id="numeroOrden" placeholder="Ej: ORD-088017-789">
                </div>
                <button class="btn btn-primary" onclick="buscarOrden()">
                    Consultar estado
                </button>
                <button class="btn btn-secondary" onclick="limpiarDatos()">
                    Limpiar datos
                </button>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Consultando tu orden...</p>
            </div>

            <!-- Error -->
            <div class="error" id="error"></div>

            <!-- Tarjeta de orden -->
            <div class="orden-card" id="ordenCard">
                <div class="orden-header">
                    <div class="numero-orden" id="ordenNumero"></div>
                    <div class="estado-badge" id="ordenEstado"></div>
                </div>
                
                <div class="orden-details" id="ordenDetails"></div>
                
                <!-- Timeline horizontal -->
                <div class="timeline-horizontal" id="timeline">
                    <div class="timeline-step" data-estado="pendiente">
                        <div class="timeline-icon">‚è≥</div>
                        <div class="timeline-label">Orden Recibida</div>
                    </div>
                    <div class="timeline-step" data-estado="confirmada">
                        <div class="timeline-icon">‚úÖ</div>
                        <div class="timeline-label">Confirmada</div>
                    </div>
                    <div class="timeline-step" data-estado="preparando">
                        <div class="timeline-icon">üë®‚Äçüç≥</div>
                        <div class="timeline-label">Preparando</div>
                    </div>
                    <div class="timeline-step" data-estado="enviada">
                        <div class="timeline-icon">üöö</div>
                        <div class="timeline-label">Enviada</div>
                    </div>
                    <div class="timeline-step" data-estado="entregada">
                        <div class="timeline-icon">üì¶</div>
                        <div class="timeline-label">Entregada</div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n de registro -->
            <div class="registro-section" id="registroSection">
                <h3>¬øQuieres que tu registro de √≥rdenes quede automatizado?</h3>
                <p>Reg√≠strate y configura tus datos de env√≠o una sola vez. Entre donde entre, ya quedar√°s registrado en esta plataforma.</p>
                <button class="btn btn-primary" style="margin-top: 12px;" onclick="mostrarFormularioRegistro()">
                    Registrarme ahora
                </button>
            </div>

            <!-- √ìrdenes guardadas -->
            <div class="ordenes-guardadas" id="ordenesGuardadas">
                <h3>Tus √≥rdenes recientes</h3>
                <div id="listaOrdenesGuardadas"></div>
            </div>
        </div>
    </div>

    <!-- Socket.IO Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <script>
        // Configuraci√≥n - actualizada para usar tu API
        const API_BASE = 'http://localhost:3000/api/ordenes';
        const SOCKET_URL = 'http://localhost:3000';
        
        // Variables globales
        let ordenesGuardadas = JSON.parse(localStorage.getItem('ordenesGuardadas') || '[]');
        let currentOrden = null;
        let socket = null;
        let historyStack = ['inicio']; // Pila para navegaci√≥n
        let eventSource = null; // Para Server-Sent Events

        // Cargar datos al iniciar
        window.onload = function() {
            inicializarSocket();
            mostrarOrdenesGuardadas();
            configurarNavegacion();
            
            // Auto-consultar √∫ltima orden si existe
            if (ordenesGuardadas.length > 0) {
                const ultimaOrden = ordenesGuardadas[ordenesGuardadas.length - 1];
                document.getElementById('numeroOrden').value = ultimaOrden.numero_orden;
                setTimeout(() => buscarOrden(), 1000);
            }
        };

        // Configurar navegaci√≥n
        function configurarNavegacion() {
            // Configurar bot√≥n de volver atr√°s
            document.getElementById('back-link').addEventListener('click', function(e) {
                e.preventDefault();
                volverAtras();
            });
            
            // Manejar el bot√≥n atr√°s del navegador
            window.addEventListener('popstate', function() {
                volverAtras();
            });
        }

        // Funci√≥n para volver atr√°s
        function volverAtras() {
            if (historyStack.length > 1) {
                historyStack.pop(); // Quitar la p√°gina actual
                const paginaAnterior = historyStack[historyStack.length - 1];
                
                // Actualizar la interfaz seg√∫n la p√°gina anterior
                actualizarVista(paginaAnterior);
                
                // Actualizar el historial del navegador
                history.pushState(null, '', window.location.pathname);
            } else {
                // Si no hay p√°ginas anteriores, ir al inicio
                actualizarVista('inicio');
            }
        }

        // Actualizar la vista seg√∫n la p√°gina
        function actualizarVista(pagina) {
            // Ocultar todos los elementos principales
            document.getElementById('ordenCard').style.display = 'none';
            document.getElementById('registroSection').style.display = 'none';
            document.getElementById('ordenesGuardadas').style.display = 'none';
            
            // Mostrar elementos seg√∫n la p√°gina
            switch(pagina) {
                case 'inicio':
                    document.getElementById('registroSection').style.display = 'block';
                    document.getElementById('ordenesGuardadas').style.display = ordenesGuardadas.length > 0 ? 'block' : 'none';
                    actualizarBreadcrumb('Inicio');
                    break;
                case 'orden':
                    document.getElementById('ordenCard').style.display = 'block';
                    actualizarBreadcrumb('Inicio', 'Detalles de orden');
                    break;
                case 'registro':
                    // Aqu√≠ ir√≠a el formulario de registro
                    actualizarBreadcrumb('Inicio', 'Registro');
                    break;
            }
        }

        // Actualizar breadcrumb
        function actualizarBreadcrumb(...items) {
            const breadcrumb = document.getElementById('breadcrumb');
            let html = '';
            
            items.forEach((item, index) => {
                if (index === items.length - 1) {
                    html += `<span>${item}</span>`;
                } else {
                    html += `<a href="#" onclick="navegarA('${item.toLowerCase()}')">${item}</a> > `;
                }
            });
            
            breadcrumb.innerHTML = html;
        }

        // Navegar a una p√°gina espec√≠fica
        function navegarA(destino) {
            historyStack.push(destino);
            actualizarVista(destino);
        }

        // Inicializar Socket.IO para actualizaciones en tiempo real
        function inicializarSocket() {
            try {
                socket = io(SOCKET_URL);
                
                socket.on('connect', () => {
                    console.log('Conectado a Socket.IO para actualizaciones en tiempo real');
                    
                    if (currentOrden && currentOrden.tienda_id) {
                        socket.emit('join-tienda-cliente', currentOrden.tienda_id);
                    }
                });
                
                socket.on('orden-actualizada', (data) => {
                    console.log('Actualizaci√≥n de orden recibida:', data);
                    
                    if (currentOrden && currentOrden.numero_orden === data.numeroOrden) {
                        actualizarOrdenEnTiempoReal(data);
                        mostrarNotificacion(`Tu orden cambi√≥ de estado: ${data.estadoAnterior} ‚Üí ${data.nuevoEstado}`, 'success');
                    }
                    
                    actualizarOrdenGuardada(data.numeroOrden, data.nuevoEstado);
                });
                
                socket.on('notificacion-personalizada', (data) => {
                    if (currentOrden && currentOrden.numero_orden === data.numeroOrden) {
                        mostrarNotificacion(data.mensaje, data.tipo || 'info');
                    }
                });
                
            } catch (error) {
                console.warn('Socket.IO no disponible:', error);
            }
        }

        // Funci√≥n principal para buscar orden
        async function buscarOrden() {
            const numeroOrden = document.getElementById('numeroOrden').value.trim();
            
            if (!numeroOrden) {
                mostrarError('Por favor ingresa un n√∫mero de orden');
                return;
            }

            mostrarLoading(true);
            ocultarError();
            
            try {
                // Consultar la API real
                const orden = await consultarOrdenAPI(numeroOrden);
                
                if (orden) {
                    mostrarOrden(orden);
                    guardarOrden(orden);
                    mostrarOrdenesGuardadas();
                    
                    // Iniciar seguimiento en tiempo real
                    iniciarSeguimientoTiempoReal(numeroOrden);
                    
                    // Navegar a la vista de orden
                    historyStack.push('orden');
                    actualizarVista('orden');
                    
                    if (socket && socket.connected && orden.tienda_id) {
                        socket.emit('join-tienda-cliente', orden.tienda_id);
                    }
                    
                } else {
                    mostrarError('Orden no encontrada. Verifica el n√∫mero ingresado.');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error al consultar la orden. Intenta nuevamente.');
            } finally {
                mostrarLoading(false);
            }
        }

        // Consultar la API real
        async function consultarOrdenAPI(numeroOrden) {
            try {
                const response = await fetch(`${API_BASE}/numero/${numeroOrden}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        return null; // Orden no encontrada
                    }
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error al consultar la API:', error);
                throw error;
            }
        }

        // Iniciar seguimiento en tiempo real usando Server-Sent Events
        function iniciarSeguimientoTiempoReal(numeroOrden) {
            // Cerrar conexi√≥n anterior si existe
            if (eventSource) {
                eventSource.close();
            }
            
            try {
                eventSource = new EventSource(`${API_BASE}/${numeroOrden}/stream`);
                
                eventSource.onopen = () => {
                    console.log('Conectado al stream de actualizaciones');
                };
                
                eventSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'orden-update') {
                        actualizarOrdenEnTiempoReal({
                            numeroOrden: data.orden.numero_orden,
                            nuevoEstado: data.orden.estado,
                            estadoAnterior: currentOrden ? currentOrden.estado : 'desconocido'
                        });
                    }
                };
                
                eventSource.onerror = (error) => {
                    console.error('Error en el stream de actualizaciones:', error);
                    // Intentar reconectar despu√©s de un tiempo
                    setTimeout(() => iniciarSeguimientoTiempoReal(numeroOrden), 5000);
                };
                
            } catch (error) {
                console.warn('SSE no disponible:', error);
            }
        }

        // Actualizar orden en tiempo real
        function actualizarOrdenEnTiempoReal(data) {
            if (!currentOrden) return;
            
            currentOrden.estado = data.nuevoEstado;
            
            const estadoBadge = document.getElementById('ordenEstado');
            estadoBadge.textContent = data.nuevoEstado.toUpperCase();
            estadoBadge.className = `estado-badge estado-${data.nuevoEstado}`;
            
            actualizarTimeline(data.nuevoEstado);
            actualizarBarraProgreso(data.nuevoEstado);
            
            // Efecto visual
            const ordenCard = document.getElementById('ordenCard');
            ordenCard.style.animation = 'pulse 0.5s ease-in-out';
            setTimeout(() => {
                ordenCard.style.animation = '';
            }, 500);
        }
        
        // Actualizar orden guardada
        function actualizarOrdenGuardada(numeroOrden, nuevoEstado) {
            const index = ordenesGuardadas.findIndex(orden => orden.numero_orden === numeroOrden);
            if (index !== -1) {
                ordenesGuardadas[index].estado = nuevoEstado;
                localStorage.setItem('ordenesGuardadas', JSON.stringify(ordenesGuardadas));
                mostrarOrdenesGuardadas();
            }
        }
        
        // Mostrar notificaciones
        function mostrarNotificacion(mensaje, tipo = 'info') {
            // Crear elemento de notificaci√≥n
            const notificacion = document.createElement('div');
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 4px;
                color: white;
                z-index: 1000;
                max-width: 300px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                transition: transform 0.3s ease;
            `;
            
            // Colores seg√∫n el tipo
            switch(tipo) {
                case 'success':
                    notificacion.style.backgroundColor = '#28a745';
                    break;
                case 'error':
                    notificacion.style.backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    notificacion.style.backgroundColor = '#ffc107';
                    notificacion.style.color = '#212529';
                    break;
                default:
                    notificacion.style.backgroundColor = '#17a2b8';
            }
            
            notificacion.textContent = mensaje;
            document.body.appendChild(notificacion);
            
            // Animaci√≥n de entrada
            setTimeout(() => {
                notificacion.style.transform = 'translateX(0)';
            }, 10);
            
            // Auto-eliminar despu√©s de 5 segundos
            setTimeout(() => {
                notificacion.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notificacion.parentNode) {
                        notificacion.parentNode.removeChild(notificacion);
                    }
                }, 300);
            }, 5000);
        }

        // Mostrar orden
        function mostrarOrden(orden) {
            currentOrden = orden;
            
            document.getElementById('ordenNumero').textContent = orden.numero_orden;
            
            const estadoBadge = document.getElementById('ordenEstado');
            estadoBadge.textContent = orden.estado.toUpperCase();
            estadoBadge.className = `estado-badge estado-${orden.estado}`;
            
            const details = document.getElementById('ordenDetails');
            details.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Cliente:</span>
                    <span class="detail-value">${orden.cliente_nombre}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tel√©fono:</span>
                    <span class="detail-value">${orden.cliente_telefono || 'No disponible'}</span>
                </div>
                ${orden.cliente_direccion ? `
                <div class="detail-row">
                    <span class="detail-label">Direcci√≥n:</span>
                    <span class="detail-value">${orden.cliente_direccion}</span>
                </div>
                ` : ''}
                <div class="detail-row">
                    <span class="detail-label">Total:</span>
                    <span class="detail-value">$${orden.total.toLocaleString()}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">M√©todo de pago:</span>
                    <span class="detail-value">${orden.metodo_pago}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Fecha:</span>
                    <span class="detail-value">${formatearFecha(orden.created_at)}</span>
                </div>
                ${orden.tienda_nombre ? `
                <div class="detail-row">
                    <span class="detail-label">Tienda:</span>
                    <span class="detail-value">${orden.tienda_nombre}</span>
                </div>
                ` : ''}
                ${orden.items && orden.items.length > 0 ? `
                <div class="detail-row">
                    <span class="detail-label">Productos:</span>
                    <span class="detail-value">
                        <ul style="padding-left: 20px; margin: 0;">
                            ${orden.items.map(item => `
                                <li>${item.producto_nombre}${item.variante_nombre ? ` (${item.variante_nombre})` : ''} x${item.cantidad} - $${item.precio_unitario.toLocaleString()}</li>
                            `).join('')}
                        </ul>
                    </span>
                </div>
                ` : ''}
                ${orden.notas ? `
                <div class="detail-row">
                    <span class="detail-label">Notas:</span>
                    <span class="detail-value">${orden.notas}</span>
                </div>
                ` : ''}
                ${orden.whatsapp ? `
                <div class="detail-row">
                    <span class="detail-label">Contacto:</span>
                    <span class="detail-value">
                        <a href="https://wa.me/${orden.whatsapp.replace('+', '')}" target="_blank" style="color: #0645ad; text-decoration: none;">
                            üì± Contactar por WhatsApp
                        </a>
                    </span>
                </div>
                ` : ''}
            `;
            
            actualizarTimeline(orden.estado);
            actualizarBarraProgreso(orden.estado);
        }

        // Actualizar timeline horizontal
        function actualizarTimeline(estadoActual) {
            const estados = ['pendiente', 'confirmada', 'preparando', 'enviada', 'entregada'];
            const estadoIndex = estados.indexOf(estadoActual);
            
            document.querySelectorAll('.timeline-step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                
                if (index < estadoIndex) {
                    step.classList.add('completed');
                } else if (index === estadoIndex) {
                    step.classList.add('active');
                }
            });
        }

        // Actualizar barra de progreso
        function actualizarBarraProgreso(estadoActual) {
            const estados = ['pendiente', 'confirmada', 'preparando', 'enviada', 'entregada'];
            const estadoIndex = estados.indexOf(estadoActual);
            const porcentaje = (estadoIndex / (estados.length - 1)) * 100;
            
            document.getElementById('progress-bar').style.width = `${porcentaje}%`;
        }

        // Guardar orden en localStorage
        function guardarOrden(orden) {
            ordenesGuardadas = ordenesGuardadas.filter(o => o.numero_orden !== orden.numero_orden);
            
            ordenesGuardadas.push({
                numero_orden: orden.numero_orden,
                cliente_nombre: orden.cliente_nombre,
                estado: orden.estado,
                total: orden.total,
                fecha_consulta: new Date().toISOString()
            });
            
            if (ordenesGuardadas.length > 5) {
                ordenesGuardadas = ordenesGuardadas.slice(-5);
            }
            
            localStorage.setItem('ordenesGuardadas', JSON.stringify(ordenesGuardadas));
        }

        // Mostrar √≥rdenes guardadas
        function mostrarOrdenesGuardadas() {
            const container = document.getElementById('ordenesGuardadas');
            const lista = document.getElementById('listaOrdenesGuardadas');
            
            if (ordenesGuardadas.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            lista.innerHTML = ordenesGuardadas.map(orden => `
                <div class="orden-guardada" onclick="cargarOrdenGuardada('${orden.numero_orden}')">
                    <div>
                        <strong>${orden.numero_orden}</strong><br>
                        <small>${orden.cliente_nombre} - $${orden.total.toLocaleString()}</small>
                    </div>
                    <div class="estado-badge estado-${orden.estado}">
                        ${orden.estado}
                    </div>
                </div>
            `).join('');
        }

        // Cargar orden guardada
        function cargarOrdenGuardada(numeroOrden) {
            document.getElementById('numeroOrden').value = numeroOrden;
            buscarOrden();
        }

        // Limpiar datos guardados
        function limpiarDatos() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar todas las √≥rdenes guardadas?')) {
                localStorage.removeItem('ordenesGuardadas');
                ordenesGuardadas = [];
                mostrarOrdenesGuardadas();
                document.getElementById('ordenCard').style.display = 'none';
                document.getElementById('numeroOrden').value = '';
                actualizarVista('inicio');
                
                // Cerrar conexi√≥n de seguimiento
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            }
        }

        // Mostrar formulario de registro
        function mostrarFormularioRegistro() {
            alert('Aqu√≠ se mostrar√≠a el formulario de registro. Esta funcionalidad se implementar√≠a en una versi√≥n completa.');
            // En una implementaci√≥n real, aqu√≠ se mostrar√≠a un formulario de registro
        }

        // Utilidades
        function mostrarLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function mostrarError(mensaje) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = mensaje;
            errorDiv.style.display = 'block';
        }

        function ocultarError() {
            document.getElementById('error').style.display = 'none';
        }

        function formatearFecha(fechaISO) {
            const fecha = new Date(fechaISO);
            return fecha.toLocaleString('es-CO', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Permitir buscar con Enter
        document.getElementById('numeroOrden').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buscarOrden();
            }
        });

        // Agregar animaci√≥n de pulso
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.02); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>